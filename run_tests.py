from __future__ import annotations

import subprocess
import sys

TESTS_THAT_NEED_FIX = [
    "test_arithmetic_expr",
    "test_arithmetic_expr_left_literal",
    "test_cast",
    "test_cast_binary",
    "test_cast_datetime_tz_aware",
    "test_cast_datetime_utc",
    "test_cast_raises_for_unknown_dtype",
    "test_cast_time",
    "test_cast_to_enum_v1",
    "test_cast_to_enum_vmain",
    "test_categorical",
    "test_concat_str",
    "test_concat_str_with_lit",
    "test_concat_vertical",
    "test_contains_case_insensitive",
    "test_contains_case_sensitive",
    "test_contains_expr",
    "test_contains_literal",
    "test_convert_time_zone",
    "test_convert_time_zone_from_none",
    "test_datetime",
    "test_datetime_attributes",
    "test_diff_lazy",
    "test_diff_lazy_grouped",
    "test_drop_nulls_agg",
    "test_dt_to_string_expr",
    "test_dt_to_string_iso_local_date_expr",
    "test_dt_to_string_iso_local_datetime_expr",
    "test_empty_scalar_reduction_with_columns",
    "test_ends_with",
    "test_explode_invalid_operation_error",
    "test_explode_multiple_cols",
    "test_explode_shape_error",
    "test_explode_single_col",
    "test_expr_binary",
    "test_expr_floordiv_by_zero",
    "test_expr_rfloordiv_by_zero",
    "test_fill_nan",
    "test_fill_null_limits",
    "test_fill_null_strategies_with_limit_as_none",
    "test_fill_null_strategies_with_partition_by",
    "test_filter",
    "test_filter_missing_column",
    "test_first_expr_over_order_by",
    "test_first_expr_over_order_by_partition_by",
    "test_format",
    "test_get_expr",
    "test_get_field_expr",
    "test_group_by_categorical",
    "test_group_by_median",
    "test_is_close_expr_with_expr",
    "test_is_close_expr_with_scalar",
    "test_is_finite_expr",
    "test_joinasof_by",
    "test_joinasof_numeric",
    "test_joinasof_suffix",
    "test_joinasof_time",
    "test_kurtosis_expr",
    "test_lazy_rank_expr",
    "test_lazy_rank_expr_desc",
    "test_left_to_right_broadcasting",
    "test_len_expr",
    "test_mapping_key_not_in_expr",
    "test_median_expr",
    "test_median_expr_raises_on_str",
    "test_missing_columns",
    "test_mode_expr_keep_all_lazy",
    "test_mode_expr_keep_any",
    "test_mode_group_by_multimodal",
    "test_mode_group_by_multiple_cols",
    "test_mode_group_by_unimodal",
    "test_n_unique_over",
    "test_namespace_from_native_object",
    "test_nan",
    "test_nan_non_float",
    "test_native_namespace_frame",
    "test_offset_by",
    "test_offset_by_dst",
    "test_offset_by_invalid_interval",
    "test_offset_by_tz",
    "test_order_dependent_raises_in_lazy",
    "test_over_anonymous_reduction",
    "test_over_pushdown",
    "test_over_quantile",
    "test_over_std_var",
    "test_package_version",
    "test_parse_weight",
    "test_pipe_expr",
    "test_quantile_expr",
    "test_rank_expr_in_over_context",
    "test_rank_expr_in_over_desc",
    "test_rank_with_order_by",
    "test_rank_with_order_by_and_partition_by",
    "test_replace_strict_expr_basic",
    "test_replace_strict_expr_with_default",
    "test_replace_strict_non_full",
    "test_replace_strict_with_default_and_nulls",
    "test_replace_strict_with_default_mapping",
    "test_replace_strict_with_expressified_default",
    "test_replace_time_zone",
    "test_replace_time_zone_none",
    "test_right_arithmetic_expr",
    "test_rolling_std_expr_lazy_grouped",
    "test_rolling_std_expr_lazy_ungrouped",
    "test_select_duplicates",
    "test_set_ops",
    "test_skew_expr",
    "test_split_list_get",
    "test_starts_with",
    "test_std_broadcating",
    "test_str_head",
    "test_str_len_chars",
    "test_str_replace_all_expr_multivalue",
    "test_str_replace_all_expr_scalar",
    "test_str_replace_errors_expr",
    "test_str_replace_expr_multivalue",
    "test_str_replace_expr_scalar",
    "test_str_slice",
    "test_str_split",
    "test_str_strip_chars",
    "test_str_tail",
    "test_str_to_lowercase",
    "test_str_to_titlecase_expr",
    "test_str_to_uppercase",
    "test_str_zfill",
    "test_sumh_broadcasting",
    "test_sumh_transformations",
    "test_timestamp_dates",
    "test_timestamp_datetimes",
    "test_timestamp_datetimes_tz_aware",
    "test_timestamp_invalid_date",
    "test_to_date",
    "test_to_date_infer_fmt_expr",
    "test_to_date_with_fmt_expr",
    "test_to_datetime",
    "test_to_datetime_infer_fmt",
    "test_to_datetime_infer_fmt_from_date",
    "test_to_datetime_tz_aware",
    "test_top_k",
    "test_top_k_by_multiple",
    "test_truncate",
    "test_truncate_invalid_interval",
    "test_truncate_invalid_multiple",
    "test_truncate_multiples",
    "test_tz_aware",
    "test_unary",
    "test_unique",
    "test_unique_3069",
    "test_unique_expr",
    "test_unique_expr_agg",
    "test_unique_full_subset",
    "test_unique_invalid",
    "test_unique_none",
    "test_when_then_broadcasting",
    "test_when_then_otherwise_aggregate_with_columns",
    "test_with_columns_dtypes_single_row",
    "test_with_columns_missing_column",
]

command = [
    "pytest",
    "narwhals/tests",
    "-p",
    "pytest_constructor_override",
    "-p",
    "env",
    "--use-external-constructor",
    "--constructors",
    "daft",
    "-k",
    f"not ({' or '.join(TESTS_THAT_NEED_FIX)})",
]

if len(sys.argv) > 1:
    command.extend(sys.argv[1:])

try:
    subprocess.run(command, check=True)
except subprocess.CalledProcessError as e:
    print("Exit code:", e.returncode)
